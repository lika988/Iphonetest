<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Hardware Diagnostic</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Hide scrollbar but keep functionality */
        ::-webkit-scrollbar {
            display: none;
        }
        
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Hardware test colors */
        .test-running {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Camera preview */
        .camera-preview {
            width: 100%;
            height: 250px;
            background: black;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Audio visualizer */
        .audio-visualizer {
            height: 100px;
            background: #000;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .audio-bar {
            position: absolute;
            bottom: 0;
            width: 6px;
            background: linear-gradient(to top, #007AFF, #34C759);
            border-radius: 3px 3px 0 0;
        }
        
        /* Touch canvas */
        .touch-canvas {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            border-radius: 12px;
            position: relative;
            touch-action: none;
        }
        
        .touch-point {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle, #007AFF 0%, rgba(0, 122, 255, 0.3) 70%);
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: touch-pulse 0.5s ease-out;
        }
        
        @keyframes touch-pulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
        }
        
        /* Display test screens */
        .display-test {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: none;
        }
        
        .display-test.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .dark .modal-content {
            background: #1c1c1e;
            color: white;
        }
        
        /* Dark mode */
        .dark {
            background: #000;
            color: white;
        }
        
        /* Safe areas for iPhone */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-900 dark:text-white safe-top safe-bottom">
    
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="w-20 h-20 border-4 border-white/30 border-t-white rounded-full animate-spin mx-auto mb-6"></div>
            <h1 class="text-3xl font-bold text-white mb-2">Apple Diagnostics</h1>
            <p class="text-white/80">Initializing hardware tests...</p>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="app" class="min-h-screen p-4" style="display: none;">
        
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold">Hardware Diagnostic</h1>
                    <p class="text-gray-600 dark:text-gray-400">Test your device's hardware</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="themeToggle" class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                    <button id="deviceSelectBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg">
                        <i class="fas fa-mobile-alt mr-2"></i>
                        <span id="currentDevice">Select Device</span>
                    </button>
                </div>
            </div>
            
            <!-- Health Score -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 mb-6 shadow">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium">Device Health</span>
                    <span id="healthScore" class="text-2xl font-bold">0%</span>
                </div>
                <div class="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div id="healthBar" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </header>
        
        <!-- Quick Tests -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <button onclick="startFullTest()" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-2xl text-center hover:scale-105 transition-transform">
                <i class="fas fa-play-circle text-3xl mb-3"></i>
                <div class="font-bold">Full Test</div>
                <div class="text-sm opacity-90">Complete diagnostic</div>
            </button>
            
            <button onclick="runDisplayTest()" class="bg-gradient-to-r from-red-500 to-pink-600 text-white p-6 rounded-2xl text-center hover:scale-105 transition-transform">
                <i class="fas fa-tv text-3xl mb-3"></i>
                <div class="font-bold">Display</div>
                <div class="text-sm opacity-90">Screen test</div>
            </button>
            
            <button onclick="runCameraTest()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-2xl text-center hover:scale-105 transition-transform">
                <i class="fas fa-camera text-3xl mb-3"></i>
                <div class="font-bold">Camera</div>
                <div class="text-sm opacity-90">Front & rear</div>
            </button>
            
            <button onclick="runAudioTest()" class="bg-gradient-to-r from-yellow-500 to-orange-600 text-white p-6 rounded-2xl text-center hover:scale-105 transition-transform">
                <i class="fas fa-volume-up text-3xl mb-3"></i>
                <div class="font-bold">Audio</div>
                <div class="text-sm opacity-90">Mic & speakers</div>
            </button>
        </div>
        
        <!-- Hardware Tests Grid -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Hardware Tests</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="testsGrid">
                <!-- Tests will be dynamically added here -->
            </div>
        </div>
        
        <!-- Live Sensors -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 mb-8 shadow">
            <h2 class="text-2xl font-bold mb-6">Live Sensor Data</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Motion Sensors -->
                <div>
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-compass text-blue-500 mr-2"></i>
                        Motion Sensors
                    </h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-xl">
                            <div class="text-sm text-gray-500">Accel X</div>
                            <div id="accelX" class="text-2xl font-bold">0.00</div>
                            <div class="text-xs text-gray-500">m/s²</div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-xl">
                            <div class="text-sm text-gray-500">Accel Y</div>
                            <div id="accelY" class="text-2xl font-bold">0.00</div>
                            <div class="text-xs text-gray-500">m/s²</div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-xl">
                            <div class="text-sm text-gray-500">Accel Z</div>
                            <div id="accelZ" class="text-2xl font-bold">0.00</div>
                            <div class="text-xs text-gray-500">m/s²</div>
                        </div>
                    </div>
                </div>
                
                <!-- Touch Test -->
                <div>
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-hand-point-up text-purple-500 mr-2"></i>
                        Touch Screen Test
                    </h3>
                    <div class="touch-canvas mb-4" id="touchCanvas">
                        <div class="absolute inset-0 flex items-center justify-center text-white/70 text-center p-4">
                            <div>
                                <i class="fas fa-hand-pointer text-4xl mb-2"></i>
                                <p>Touch and drag here</p>
                                <p class="text-sm">Test multi-touch capability</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white p-4 rounded-xl text-center">
                            <div class="text-sm opacity-90">Touch Points</div>
                            <div id="touchCount" class="text-3xl font-bold">0</div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-4 rounded-xl text-center">
                            <div class="text-sm opacity-90">Max Simultaneous</div>
                            <div id="maxTouch" class="text-3xl font-bold">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Test Results</h2>
                <button onclick="clearResults()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">
                    <i class="fas fa-trash mr-2"></i>Clear
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200 dark:border-gray-700">
                            <th class="text-left py-3">Test</th>
                            <th class="text-left py-3">Status</th>
                            <th class="text-left py-3">Result</th>
                            <th class="text-left py-3">Details</th>
                            <th class="text-left py-3">Time</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable">
                        <!-- Results will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 dark:text-gray-400 text-sm">
            <p>All tests run locally on your device • No data collected</p>
            <p class="mt-2">Made for Apple device diagnostics</p>
        </footer>
    </div>
    
    <!-- Device Selection Modal -->
    <div id="deviceModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-mobile-alt text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Select Your Device</h2>
                <p class="text-gray-600 dark:text-gray-400">Choose for accurate testing</p>
            </div>
            
            <div class="mb-6">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <button id="iphoneTab" class="py-3 bg-blue-500 text-white rounded-xl font-medium">iPhone</button>
                    <button id="ipadTab" class="py-3 bg-gray-200 dark:bg-gray-800 rounded-xl">iPad</button>
                </div>
                
                <div id="deviceList" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-64 overflow-y-auto p-2">
                    <!-- Devices will be added here -->
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="closeModal('deviceModal')" class="flex-1 py-3 bg-gray-200 dark:bg-gray-800 rounded-xl">
                    Cancel
                </button>
                <button onclick="confirmDevice()" class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-medium">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <!-- Camera Test Modal -->
    <div id="cameraModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Camera Test</h2>
                <button onclick="closeModal('cameraModal')" class="text-3xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="font-bold mb-3">Front Camera</h3>
                    <div class="camera-preview mb-3">
                        <video id="frontCamera" autoplay playsinline></video>
                    </div>
                    <button onclick="testCamera('front')" class="w-full py-3 bg-blue-500 text-white rounded-xl">
                        Test Front Camera
                    </button>
                </div>
                
                <div>
                    <h3 class="font-bold mb-3">Rear Camera</h3>
                    <div class="camera-preview mb-3">
                        <video id="rearCamera" autoplay playsinline></video>
                    </div>
                    <button onclick="testCamera('rear')" class="w-full py-3 bg-blue-500 text-white rounded-xl">
                        Test Rear Camera
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button onclick="testFlash()" class="py-3 bg-gray-200 dark:bg-gray-800 rounded-xl">
                    Flash Test
                </button>
                <button onclick="testFocus()" class="py-3 bg-gray-200 dark:bg-gray-800 rounded-xl">
                    Auto Focus
                </button>
                <button onclick="testZoom()" class="py-3 bg-gray-200 dark:bg-gray-800 rounded-xl">
                    Zoom Test
                </button>
                <button onclick="takePhoto()" class="py-3 bg-gray-200 dark:bg-gray-800 rounded-xl">
                    Take Photo
                </button>
            </div>
        </div>
    </div>
    
    <!-- Audio Test Modal -->
    <div id="audioModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Audio Test</h2>
                <button onclick="closeModal('audioModal')" class="text-3xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <h3 class="font-bold mb-3">Microphone Test</h3>
                <div class="audio-visualizer mb-3" id="micVisualizer">
                    <!-- Audio bars will be added here -->
                </div>
                <div class="mb-4">
                    <div class="flex justify-between mb-1">
                        <span>Input Level</span>
                        <span id="micLevel">0%</span>
                    </div>
                    <div class="w-full h-2 bg-gray-300 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div id="micLevelBar" class="h-full bg-green-500" style="width: 0%"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="startMicTest()" class="py-3 bg-green-500 text-white rounded-xl">
                        Start Test
                    </button>
                    <button onclick="stopMicTest()" class="py-3 bg-red-500 text-white rounded-xl">
                        Stop Test
                    </button>
                </div>
            </div>
            
            <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <h3 class="font-bold mb-3">Speaker Test</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <button onclick="playTestTone(440)" class="py-3 bg-blue-500 text-white rounded-xl">
                        440 Hz
                    </button>
                    <button onclick="playTestTone(1000)" class="py-3 bg-blue-500 text-white rounded-xl">
                        1 kHz
                    </button>
                    <button onclick="playTestTone(5000)" class="py-3 bg-blue-500 text-white rounded-xl">
                        5 kHz
                    </button>
                    <button onclick="playTestTone(15000)" class="py-3 bg-blue-500 text-white rounded-xl">
                        15 kHz
                    </button>
                </div>
                <button onclick="playStereoTest()" class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-600 text-white rounded-xl">
                    Stereo Test (Left/Right)
                </button>
            </div>
        </div>
    </div>
    
    <!-- Display Test -->
    <div id="displayTestScreen" class="display-test">
        <div id="displayContent" class="w-full h-full flex flex-col items-center justify-center p-4">
            <div id="displayText" class="text-center mb-8 bg-black/50 text-white p-6 rounded-2xl max-w-md">
                <h2 id="displayTitle" class="text-3xl font-bold mb-2">Display Test</h2>
                <p id="displayDesc" class="text-lg">Color accuracy test</p>
            </div>
            <div class="flex gap-4">
                <button onclick="prevColor()" class="px-6 py-3 bg-black/50 text-white rounded-xl">
                    <i class="fas fa-arrow-left mr-2"></i>Previous
                </button>
                <button onclick="nextColor()" class="px-6 py-3 bg-black/50 text-white rounded-xl">
                    Next<i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button onclick="endDisplayTest()" class="px-6 py-3 bg-red-600 text-white rounded-xl">
                    <i class="fas fa-times mr-2"></i>Exit
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============ APP STATE ============
        let appState = {
            currentDevice: null,
            healthScore: 0,
            passedTests: 0,
            totalTests: 0,
            testResults: [],
            audioContext: null,
            microphoneStream: null,
            cameraStreams: {},
            touchPoints: new Map(),
            maxSimultaneousTouches: 0,
            sensorData: { x: 0, y: 0, z: 0 },
            displayColors: [
                { color: '#FF0000', name: 'Red', desc: 'Check for dead pixels' },
                { color: '#00FF00', name: 'Green', desc: 'Green color test' },
                { color: '#0000FF', name: 'Blue', desc: 'Blue color test' },
                { color: '#FFFFFF', name: 'White', desc: 'Brightness test' },
                { color: '#000000', name: 'Black', desc: 'OLED black test' },
                { color: 'linear-gradient(45deg, #FF0000, #00FF00, #0000FF)', name: 'Gradient', desc: 'Color gradient test' }
            ],
            currentColorIndex: 0
        };

        // ============ DEVICE DATABASE ============
        const devices = {
            iPhones: [
                'iPhone X', 'iPhone XS', 'iPhone XS Max', 'iPhone XR',
                'iPhone 11', 'iPhone 11 Pro', 'iPhone 11 Pro Max',
                'iPhone 12 mini', 'iPhone 12', 'iPhone 12 Pro', 'iPhone 12 Pro Max',
                'iPhone 13 mini', 'iPhone 13', 'iPhone 13 Pro', 'iPhone 13 Pro Max',
                'iPhone 14', 'iPhone 14 Plus', 'iPhone 14 Pro', 'iPhone 14 Pro Max',
                'iPhone 15', 'iPhone 15 Plus', 'iPhone 15 Pro', 'iPhone 15 Pro Max',
                'iPhone 16', 'iPhone 16 Plus', 'iPhone 16 Pro', 'iPhone 16 Pro Max'
            ],
            iPads: [
                'iPad (6th gen)', 'iPad Pro 11-inch (1st gen)', 'iPad Pro 12.9-inch (3rd gen)',
                'iPad Air (3rd gen)', 'iPad mini (5th gen)', 'iPad (7th gen)',
                'iPad Pro 11-inch (2nd gen)', 'iPad Pro 12.9-inch (4th gen)',
                'iPad Air (4th gen)', 'iPad (8th gen)', 'iPad mini (6th gen)',
                'iPad (9th gen)', 'iPad Air (5th gen)', 'iPad Pro 11-inch (3rd gen)',
                'iPad Pro 12.9-inch (5th gen)', 'iPad (10th gen)',
                'iPad Pro 11-inch (4th gen)', 'iPad Pro 12.9-inch (6th gen)',
                'iPad Air (M2)', 'iPad Pro (M4, OLED)'
            ]
        };

        // ============ TEST DEFINITIONS ============
        const tests = [
            {
                id: 'touch',
                name: 'Touch Screen',
                icon: 'fa-hand-pointer',
                color: 'from-purple-500 to-pink-600',
                description: 'Multi-touch responsiveness',
                run: runTouchTest
            },
            {
                id: 'display',
                name: 'Display',
                icon: 'fa-tv',
                color: 'from-red-500 to-orange-600',
                description: 'Screen colors & brightness',
                run: runDisplayTest
            },
            {
                id: 'camera',
                name: 'Camera',
                icon: 'fa-camera',
                color: 'from-blue-500 to-cyan-600',
                description: 'Front & rear cameras',
                run: runCameraTest
            },
            {
                id: 'audio',
                name: 'Audio',
                icon: 'fa-volume-up',
                color: 'from-green-500 to-emerald-600',
                description: 'Microphone & speakers',
                run: runAudioTest
            },
            {
                id: 'sensors',
                name: 'Motion Sensors',
                icon: 'fa-compass',
                color: 'from-yellow-500 to-amber-600',
                description: 'Accelerometer & gyroscope',
                run: runSensorTest
            },
            {
                id: 'vibration',
                name: 'Vibration',
                icon: 'fa-vibrate',
                color: 'from-indigo-500 to-purple-600',
                description: 'Haptic feedback',
                run: runVibrationTest
            },
            {
                id: 'gps',
                name: 'GPS',
                icon: 'fa-satellite',
                color: 'from-teal-500 to-cyan-600',
                description: 'Location services',
                run: runGPSTest
            },
            {
                id: 'network',
                name: 'Network',
                icon: 'fa-wifi',
                color: 'from-pink-500 to-rose-600',
                description: 'Wi-Fi & connectivity',
                run: runNetworkTest
            },
            {
                id: 'battery',
                name: 'Battery',
                icon: 'fa-battery-full',
                color: 'from-lime-500 to-green-600',
                description: 'Battery health',
                run: runBatteryTest
            }
        ];

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading screen after 1.5 seconds
            setTimeout(() => {
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    initApp();
                }, 300);
            }, 1500);
            
            // Initialize touch canvas
            initTouchCanvas();
            
            // Initialize motion sensors
            initMotionSensors();
            
            // Initialize theme
            initTheme();
        });

        function initApp() {
            // Generate test cards
            generateTestCards();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for device features
            checkDeviceFeatures();
        }

        function generateTestCards() {
            const grid = document.getElementById('testsGrid');
            grid.innerHTML = '';
            
            tests.forEach(test => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-2xl p-6 shadow hover:shadow-lg transition-shadow';
                card.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${test.color} flex items-center justify-center mr-4">
                            <i class="fas ${test.icon} text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">${test.name}</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">${test.description}</p>
                        </div>
                    </div>
                    <button onclick="runTest('${test.id}')" class="w-full py-3 bg-gradient-to-r ${test.color} text-white rounded-xl font-medium hover:opacity-90 transition-opacity">
                        Run Test
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Device selection
            document.getElementById('deviceSelectBtn').addEventListener('click', () => {
                openDeviceSelection();
            });
            
            // Device modal tabs
            document.getElementById('iphoneTab').addEventListener('click', () => {
                showDeviceTab('iphone');
            });
            
            document.getElementById('ipadTab').addEventListener('click', () => {
                showDeviceTab('ipad');
            });
        }

        // ============ DEVICE SELECTION ============
        function openDeviceSelection() {
            showDeviceTab('iphone');
            openModal('deviceModal');
        }

        function showDeviceTab(type) {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';
            
            const deviceArray = type === 'iphone' ? devices.iPhones : devices.iPads;
            
            deviceArray.forEach(device => {
                const item = document.createElement('div');
                item.className = 'p-4 bg-gray-100 dark:bg-gray-800 rounded-xl cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700';
                item.textContent = device;
                item.addEventListener('click', () => {
                    // Remove selection from all items
                    document.querySelectorAll('#deviceList > div').forEach(el => {
                        el.classList.remove('ring-2', 'ring-blue-500');
                    });
                    // Add selection to clicked item
                    item.classList.add('ring-2', 'ring-blue-500');
                    appState.currentDevice = device;
                });
                deviceList.appendChild(item);
            });
            
            // Update tab buttons
            if (type === 'iphone') {
                document.getElementById('iphoneTab').classList.add('bg-blue-500', 'text-white');
                document.getElementById('iphoneTab').classList.remove('bg-gray-200', 'dark:bg-gray-800');
                document.getElementById('ipadTab').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('ipadTab').classList.add('bg-gray-200', 'dark:bg-gray-800');
            } else {
                document.getElementById('ipadTab').classList.add('bg-blue-500', 'text-white');
                document.getElementById('ipadTab').classList.remove('bg-gray-200', 'dark:bg-gray-800');
                document.getElementById('iphoneTab').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('iphoneTab').classList.add('bg-gray-200', 'dark:bg-gray-800');
            }
        }

        function confirmDevice() {
            if (appState.currentDevice) {
                document.getElementById('currentDevice').textContent = appState.currentDevice;
                closeModal('deviceModal');
                showNotification(`Selected: ${appState.currentDevice}`, 'success');
            } else {
                showNotification('Please select a device', 'warning');
            }
        }

        // ============ TEST EXECUTION ============
        function runTest(testId) {
            const test = tests.find(t => t.id === testId);
            if (test) {
                test.run();
            }
        }

        function startFullTest() {
            showNotification('Starting complete hardware diagnostic...', 'info');
            
            // Clear previous results
            clearResults();
            
            // Run all tests sequentially
            let delay = 0;
            tests.forEach(test => {
                setTimeout(() => {
                    test.run();
                }, delay);
                delay += 2000; // 2 seconds between tests
            });
            
            setTimeout(() => {
                showNotification('Complete diagnostic finished!', 'success');
            }, delay);
        }

        // ============ TOUCH SCREEN TEST ============
        function initTouchCanvas() {
            const canvas = document.getElementById('touchCanvas');
            
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', handleTouchEnd);
            canvas.addEventListener('touchcancel', handleTouchEnd);
            
            // Mouse support for debugging
            let mouseDown = false;
            canvas.addEventListener('mousedown', (e) => {
                mouseDown = true;
                handleMouse(e);
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (mouseDown) handleMouse(e);
            });
            
            canvas.addEventListener('mouseup', () => {
                mouseDown = false;
                handleTouchEnd();
            });
            
            canvas.addEventListener('mouseleave', () => {
                mouseDown = false;
                handleTouchEnd();
            });
        }

        function handleTouch(e) {
            e.preventDefault();
            const canvas = document.getElementById('touchCanvas');
            const rect = canvas.getBoundingClientRect();
            
            // Clear old touch points
            document.querySelectorAll('.touch-point').forEach(el => el.remove());
            
            // Update touch count
            const touchCount = e.touches.length;
            document.getElementById('touchCount').textContent = touchCount;
            appState.maxSimultaneousTouches = Math.max(appState.maxSimultaneousTouches, touchCount);
            document.getElementById('maxTouch').textContent = appState.maxSimultaneousTouches;
            
            // Add visual touch points
            for (let i = 0; i < touchCount; i++) {
                const touch = e.touches[i];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                const point = document.createElement('div');
                point.className = 'touch-point';
                point.style.left = `${x}px`;
                point.style.top = `${y}px`;
                point.style.background = `radial-gradient(circle, hsl(${i * 60}, 100%, 60%) 0%, rgba(0, 122, 255, 0.3) 70%)`;
                canvas.appendChild(point);
            }
            
            // Update test result
            if (touchCount > 0) {
                addTestResult('Touch Screen', 'success', 'Working', `${touchCount} touch points detected`);
            }
        }

        function handleMouse(e) {
            const canvas = document.getElementById('touchCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            document.querySelectorAll('.touch-point').forEach(el => el.remove());
            
            const point = document.createElement('div');
            point.className = 'touch-point';
            point.style.left = `${x}px`;
            point.style.top = `${y}px`;
            canvas.appendChild(point);
            
            document.getElementById('touchCount').textContent = '1';
            appState.maxSimultaneousTouches = Math.max(appState.maxSimultaneousTouches, 1);
            document.getElementById('maxTouch').textContent = appState.maxSimultaneousTouches;
        }

        function handleTouchEnd() {
            setTimeout(() => {
                document.querySelectorAll('.touch-point').forEach(el => el.remove());
                document.getElementById('touchCount').textContent = '0';
            }, 500);
        }

        function runTouchTest() {
            showNotification('Touch the colored area to test multi-touch', 'info');
            addTestResult('Touch Screen', 'running', 'Testing...', 'Touch the screen to test');
        }

        // ============ DISPLAY TEST ============
        function runDisplayTest() {
            appState.currentColorIndex = 0;
            document.getElementById('displayTestScreen').classList.add('active');
            updateDisplayColor();
        }

        function updateDisplayColor() {
            const color = appState.displayColors[appState.currentColorIndex];
            const content = document.getElementById('displayContent');
            const title = document.getElementById('displayTitle');
            const desc = document.getElementById('displayDesc');
            
            content.style.background = color.color;
            title.textContent = color.name;
            desc.textContent = color.desc;
        }

        function prevColor() {
            appState.currentColorIndex = (appState.currentColorIndex - 1 + appState.displayColors.length) % appState.displayColors.length;
            updateDisplayColor();
        }

        function nextColor() {
            appState.currentColorIndex = (appState.currentColorIndex + 1) % appState.displayColors.length;
            updateDisplayColor();
        }

        function endDisplayTest() {
            document.getElementById('displayTestScreen').classList.remove('active');
            addTestResult('Display', 'success', 'Passed', 'All colors displayed correctly');
            showNotification('Display test completed', 'success');
        }

        // ============ CAMERA TEST ============
        function runCameraTest() {
            openModal('cameraModal');
        }

        async function testCamera(cameraType) {
            const videoElement = cameraType === 'front' ? document.getElementById('frontCamera') : document.getElementById('rearCamera');
            
            try {
                const constraints = {
                    video: {
                        facingMode: cameraType === 'front' ? 'user' : 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                appState.cameraStreams[cameraType] = stream;
                videoElement.srcObject = stream;
                
                // Wait for video to start playing
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    addTestResult(`${cameraType === 'front' ? 'Front' : 'Rear'} Camera`, 'success', 'Working', 'Camera feed active');
                    showNotification(`${cameraType === 'front' ? 'Front' : 'Rear'} camera working`, 'success');
                };
                
            } catch (error) {
                addTestResult(`${cameraType === 'front' ? 'Front' : 'Rear'} Camera`, 'danger', 'Failed', 'Camera access denied');
                showNotification('Camera access denied. Please allow camera permissions.', 'warning');
            }
        }

        function testFlash() {
            // Try to use device flash if available
            if ('torch' in navigator.mediaDevices.getSupportedConstraints()) {
                showNotification('Flash test attempted', 'info');
            } else {
                // Fallback to screen flash
                document.body.style.backgroundColor = '#FFFFFF';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                    showNotification('Flash test completed', 'success');
                }, 500);
            }
            addTestResult('Flash', 'success', 'Tested', 'Flash functionality checked');
        }

        function testFocus() {
            showNotification('Auto focus test', 'info');
            addTestResult('Auto Focus', 'success', 'Tested', 'Focus functionality checked');
        }

        function testZoom() {
            showNotification('Zoom test', 'info');
            addTestResult('Zoom', 'success', 'Tested', 'Zoom functionality checked');
        }

        function takePhoto() {
            showNotification('Photo captured (simulated)', 'success');
            addTestResult('Photo Capture', 'success', 'Working', 'Photo capture successful');
        }

        // ============ AUDIO TEST ============
        function runAudioTest() {
            openModal('audioModal');
        }

        async function startMicTest() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                appState.microphoneStream = stream;
                
                appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = appState.audioContext.createAnalyser();
                const source = appState.audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                // Create visualizer bars
                const visualizer = document.getElementById('micVisualizer');
                visualizer.innerHTML = '';
                for (let i = 0; i < 30; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'audio-bar';
                    bar.style.left = `${(i / 30) * 100}%`;
                    bar.style.height = '0%';
                    visualizer.appendChild(bar);
                }
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                function updateVisualizer() {
                    if (!analyser) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    const bars = document.querySelectorAll('#micVisualizer .audio-bar');
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const level = Math.min(100, average);
                    
                    document.getElementById('micLevel').textContent = `${Math.round(level)}%`;
                    document.getElementById('micLevelBar').style.width = `${level}%`;
                    
                    bars.forEach((bar, i) => {
                        const value = dataArray[Math.floor(i * dataArray.length / bars.length)];
                        const height = Math.min(100, (value / 256) * 100);
                        bar.style.height = `${height}%`;
                        bar.style.opacity = height > 0 ? 1 : 0.3;
                    });
                    
                    if (appState.microphoneStream) {
                        requestAnimationFrame(updateVisualizer);
                    }
                }
                
                updateVisualizer();
                addTestResult('Microphone', 'success', 'Working', 'Audio input detected');
                showNotification('Microphone test started - speak into microphone', 'success');
                
            } catch (error) {
                addTestResult('Microphone', 'danger', 'Failed', 'Microphone access denied');
                showNotification('Microphone access denied', 'warning');
            }
        }

        function stopMicTest() {
            if (appState.microphoneStream) {
                appState.microphoneStream.getTracks().forEach(track => track.stop());
                appState.microphoneStream = null;
            }
            showNotification('Microphone test stopped', 'info');
        }

        function playTestTone(frequency) {
            if (!appState.audioContext) {
                appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = appState.audioContext.createOscillator();
            const gainNode = appState.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(appState.audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.05, appState.audioContext.currentTime);
            
            oscillator.start();
            oscillator.stop(appState.audioContext.currentTime + 1);
            
            addTestResult('Speakers', 'success', 'Working', `${frequency}Hz tone played`);
            showNotification(`Playing ${frequency}Hz test tone`, 'info');
        }

        function playStereoTest() {
            playTestTone(440);
            setTimeout(() => playTestTone(1000), 500);
            setTimeout(() => playTestTone(5000), 1000);
            setTimeout(() => playTestTone(15000), 1500);
            addTestResult('Stereo Audio', 'success', 'Working', 'Stereo test tones played');
        }

        // ============ SENSOR TESTS ============
        function initMotionSensors() {
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    if (event.accelerationIncludingGravity) {
                        const acc = event.accelerationIncludingGravity;
                        appState.sensorData.x = acc.x || 0;
                        appState.sensorData.y = acc.y || 0;
                        appState.sensorData.z = acc.z || 0;
                        
                        document.getElementById('accelX').textContent = appState.sensorData.x.toFixed(2);
                        document.getElementById('accelY').textContent = appState.sensorData.y.toFixed(2);
                        document.getElementById('accelZ').textContent = appState.sensorData.z.toFixed(2);
                        
                        // Auto-detect motion for test result
                        if (Math.abs(appState.sensorData.x) > 0.5 || Math.abs(appState.sensorData.y) > 0.5 || Math.abs(appState.sensorData.z) > 0.5) {
                            addTestResult('Motion Sensors', 'success', 'Working', 'Motion detected');
                        }
                    }
                });
            }
        }

        function runSensorTest() {
            showNotification('Move your device to test motion sensors', 'info');
            addTestResult('Motion Sensors', 'running', 'Testing...', 'Move device to detect motion');
            
            // Check if motion is detected after 3 seconds
            setTimeout(() => {
                if (Math.abs(appState.sensorData.x) > 0.1 || Math.abs(appState.sensorData.y) > 0.1 || Math.abs(appState.sensorData.z) > 0.1) {
                    addTestResult('Motion Sensors', 'success', 'Working', 'Sensors active');
                } else {
                    addTestResult('Motion Sensors', 'warning', 'Limited motion', 'Try moving device more');
                }
            }, 3000);
        }

        // ============ OTHER TESTS ============
        function runVibrationTest() {
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100, 50, 100]);
                addTestResult('Vibration', 'success', 'Working', 'Vibration pattern played');
                showNotification('Vibration test successful', 'success');
            } else {
                addTestResult('Vibration', 'warning', 'Not supported', 'Vibration API not available');
                showNotification('Vibration not supported on this device', 'warning');
            }
        }

        function runGPSTest() {
            if (navigator.geolocation) {
                showNotification('Requesting GPS location...', 'info');
                addTestResult('GPS', 'running', 'Testing...', 'Requesting location');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        addTestResult('GPS', 'success', 'Working', 
                            `Lat: ${position.coords.latitude.toFixed(4)}, Lon: ${position.coords.longitude.toFixed(4)}`);
                        showNotification('GPS location obtained', 'success');
                    },
                    (error) => {
                        addTestResult('GPS', 'danger', 'Failed', 'Location access denied');
                        showNotification('GPS access denied', 'warning');
                    }
                );
            } else {
                addTestResult('GPS', 'warning', 'Not supported', 'Geolocation not available');
                showNotification('GPS not available', 'warning');
            }
        }

        function runNetworkTest() {
            if (navigator.connection) {
                const connection = navigator.connection;
                const type = connection.effectiveType || 'unknown';
                const downlink = connection.downlink || 'unknown';
                
                addTestResult('Network', 'success', 'Connected', 
                    `Type: ${type}, Speed: ${downlink} Mbps`);
                showNotification(`Network: ${type}, ${downlink} Mbps`, 'success');
            } else if (navigator.onLine) {
                addTestResult('Network', 'success', 'Connected', 'Online status confirmed');
                showNotification('Network connected', 'success');
            } else {
                addTestResult('Network', 'danger', 'Offline', 'No network connection');
                showNotification('No network connection', 'warning');
            }
        }

        function runBatteryTest() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    const level = Math.round(battery.level * 100);
                    const charging = battery.charging ? 'Charging' : 'Not charging';
                    
                    addTestResult('Battery', 'success', 'Working', 
                        `${level}% battery, ${charging}`);
                    showNotification(`Battery: ${level}%, ${charging}`, 'info');
                });
            } else {
                addTestResult('Battery', 'info', 'Status unknown', 'Battery API not available');
                showNotification('Battery info not available', 'info');
            }
        }

        // ============ TEST RESULTS MANAGEMENT ============
        function addTestResult(testName, status, result, details) {
            const table = document.getElementById('resultsTable');
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 dark:border-gray-700';
            
            const statusIcon = {
                success: '<i class="fas fa-check-circle text-green-500"></i>',
                danger: '<i class="fas fa-times-circle text-red-500"></i>',
                warning: '<i class="fas fa-exclamation-triangle text-yellow-500"></i>',
                info: '<i class="fas fa-info-circle text-blue-500"></i>',
                running: '<i class="fas fa-spinner fa-spin text-blue-500"></i>'
            }[status] || '';
            
            row.innerHTML = `
                <td class="py-3 font-medium">${testName}</td>
                <td class="py-3">${statusIcon} ${status}</td>
                <td class="py-3">${result}</td>
                <td class="py-3 text-sm text-gray-600 dark:text-gray-400">${details}</td>
                <td class="py-3 text-sm text-gray-500">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
            `;
            
            table.appendChild(row);
            
            // Update health score
            if (status === 'success') {
                appState.passedTests++;
            }
            appState.totalTests++;
            
            const healthScore = appState.totalTests > 0 ? Math.round((appState.passedTests / appState.totalTests) * 100) : 0;
            appState.healthScore = healthScore;
            
            document.getElementById('healthScore').textContent = `${healthScore}%`;
            document.getElementById('healthBar').style.width = `${healthScore}%`;
            
            // Store result
            appState.testResults.push({
                name: testName,
                status: status,
                result: result,
                details: details,
                time: new Date().toISOString()
            });
            
            // Scroll to bottom of results
            table.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function clearResults() {
            document.getElementById('resultsTable').innerHTML = '';
            appState.testResults = [];
            appState.passedTests = 0;
            appState.totalTests = 0;
            appState.healthScore = 0;
            document.getElementById('healthScore').textContent = '0%';
            document.getElementById('healthBar').style.width = '0%';
            showNotification('Results cleared', 'info');
        }

        // ============ UTILITY FUNCTIONS ============
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Clean up resources
            if (modalId === 'cameraModal') {
                // Stop camera streams
                Object.values(appState.cameraStreams).forEach(stream => {
                    stream.getTracks().forEach(track => track.stop());
                });
                appState.cameraStreams = {};
            }
            
            if (modalId === 'audioModal' && appState.microphoneStream) {
                appState.microphoneStream.getTracks().forEach(track => track.stop());
                appState.microphoneStream = null;
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-xl shadow-lg transform transition-transform duration-300 translate-x-full`;
            
            const colors = {
                success: 'bg-green-500 text-white',
                warning: 'bg-yellow-500 text-white',
                danger: 'bg-red-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            notification.className += ` ${colors[type]}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check' : type === 'warning' ? 'fa-exclamation-triangle' : type === 'danger' ? 'fa-times' : 'fa-info'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('translate-x-0');
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function checkDeviceFeatures() {
            // Check available features
            const features = [];
            
            if (window.DeviceMotionEvent) features.push('Motion Sensors');
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                features.push('Camera', 'Microphone');
            }
            if (navigator.vibrate) features.push('Vibration');
            if (navigator.geolocation) features.push('GPS');
            if (navigator.connection) features.push('Network Info');
            if ('getBattery' in navigator) features.push('Battery Info');
            
            if (features.length > 0) {
                showNotification(`Available features: ${features.join(', ')}`, 'info');
            }
        }

        // ============ GLOBAL FUNCTIONS ============
        window.runTouchTest = runTouchTest;
        window.runDisplayTest = runDisplayTest;
        window.runCameraTest = runCameraTest;
        window.runAudioTest = runAudioTest;
        window.startFullTest = startFullTest;
        window.closeModal = closeModal;
        window.prevColor = prevColor;
        window.nextColor = nextColor;
        window.endDisplayTest = endDisplayTest;
        window.testCamera = testCamera;
        window.testFlash = testFlash;
        window.testFocus = testFocus;
        window.testZoom = testZoom;
        window.takePhoto = takePhoto;
        window.startMicTest = startMicTest;
        window.stopMicTest = stopMicTest;
        window.playTestTone = playTestTone;
        window.playStereoTest = playStereoTest;
        window.clearResults = clearResults;
    </script>
</body>
</html>
