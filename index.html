<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Apple Hardware Diagnostics Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css for smooth animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Custom CSS -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800;900&family=SF+Pro+Text:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --success: #30D158;
            --warning: #FF9F0A;
            --danger: #FF453A;
            --background: #F2F2F7;
            --card: #FFFFFF;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --border: #D1D1D6;
        }
        
        .dark {
            --primary: #0A84FF;
            --primary-dark: #409CFF;
            --success: #30D158;
            --warning: #FF9F0A;
            --danger: #FF453A;
            --background: #000000;
            --card: #1C1C1E;
            --text-primary: #F5F5F7;
            --text-secondary: #8E8E93;
            --border: #38383A;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 700;
        }
        
        /* Glass Morphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .dark .glass {
            background: rgba(28, 28, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Card Styles */
        .card {
            background: var(--card);
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
        }
        
        .dark .card {
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }
        
        .dark .card:hover {
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            outline: none;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            gap: 6px;
        }
        
        .status-success {
            background: rgba(48, 209, 88, 0.15);
            color: var(--success);
        }
        
        .status-warning {
            background: rgba(255, 159, 10, 0.15);
            color: var(--warning);
        }
        
        .status-danger {
            background: rgba(255, 69, 58, 0.15);
            color: var(--danger);
        }
        
        .status-info {
            background: rgba(10, 132, 255, 0.15);
            color: var(--primary);
        }
        
        /* Progress Bars */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--primary), #5856D6);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Health Score Ring */
        .health-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--success) 0% 75%, rgba(255, 255, 255, 0.1) 75% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .health-ring-inner {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--card);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        /* Test Card */
        .test-card {
            padding: 24px;
            border-radius: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), #5856D6);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .test-card:hover::before {
            opacity: 1;
        }
        
        .test-card.running {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.2); }
            70% { box-shadow: 0 0 0 10px rgba(10, 132, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); }
        }
        
        /* Sensor Visualization */
        .sensor-visual {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #1D2B64, #2C3E50);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .sensor-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Touch Test Canvas */
        .touch-canvas {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, #0F2027, #203A43, #2C5364);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }
        
        .touch-point {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary) 0%, rgba(10, 132, 255, 0.3) 70%);
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: touchAppear 0.3s ease-out;
        }
        
        @keyframes touchAppear {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: var(--card);
            border-radius: 24px;
            padding: 32px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(30px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        /* Camera Preview */
        .camera-preview {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Audio Visualizer */
        .audio-visualizer {
            width: 100%;
            height: 150px;
            background: linear-gradient(to bottom, #000, #1a1a2e);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        
        .audio-bar {
            position: absolute;
            bottom: 0;
            width: 8px;
            background: linear-gradient(to top, var(--primary), #34C759);
            border-radius: 4px 4px 0 0;
            transform-origin: bottom;
        }
        
        /* Display Test */
        .display-test {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: background-color 0.5s ease;
        }
        
        .display-test-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Responsive Design */
        @media (max-width: 640px) {
            .container {
                padding-left: 16px;
                padding-right: 16px;
            }
            
            .modal-content {
                padding: 20px;
                max-width: 95%;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .test-card {
                padding: 16px;
            }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            .container {
                padding-left: 24px;
                padding-right: 24px;
            }
        }
        
        /* Safe Area Insets for Notch/Dynamic Island */
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-black transition-colors duration-300">
    
    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        
        <!-- Device Selection Modal -->
        <div id="deviceModal" class="modal-overlay active">
            <div class="modal-content max-w-4xl w-full mx-4">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 mx-auto mb-6 rounded-3xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-2xl">
                        <i class="fas fa-mobile-alt text-white text-4xl"></i>
                    </div>
                    <h1 class="text-4xl font-bold mb-3 bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">
                        Apple Hardware Diagnostics
                    </h1>
                    <p class="text-gray-600 dark:text-gray-400 text-lg">Select your device for comprehensive hardware testing</p>
                </div>
                
                <!-- Device Type Tabs -->
                <div class="flex space-x-2 mb-8">
                    <button id="iphoneTab" class="flex-1 py-4 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold text-lg shadow-lg">
                        <i class="fas fa-mobile-alt mr-2"></i>iPhone
                    </button>
                    <button id="ipadTab" class="flex-1 py-4 rounded-2xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-semibold text-lg">
                        <i class="fas fa-tablet-alt mr-2"></i>iPad
                    </button>
                </div>
                
                <!-- Device Grid -->
                <div id="iphoneGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-2">
                    <!-- iPhone devices will be populated here -->
                </div>
                
                <div id="ipadGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto p-2 hidden">
                    <!-- iPad devices will be populated here -->
                </div>
                
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="confirmDevice" class="btn btn-primary flex-1 text-lg py-4">
                            <i class="fas fa-check-circle"></i>
                            Continue with Selected Device
                        </button>
                        <button id="skipDetection" class="btn btn-secondary flex-1 text-lg py-4">
                            <i class="fas fa-forward"></i>
                            Use Basic Tests
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Dashboard -->
        <div id="dashboard" class="min-h-screen p-4 md:p-6 lg:p-8" style="display: none;">
            
            <!-- Top Navigation Bar -->
            <header class="mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg">
                            <i class="fas fa-stethoscope text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold">Hardware Diagnostics Pro</h1>
                            <div class="flex items-center space-x-2 mt-1">
                                <span id="deviceBadge" class="status-badge status-info">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span id="currentDevice">Select Device</span>
                                </span>
                                <span id="deviceYear" class="text-sm text-gray-500 dark:text-gray-400"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3">
                        <button id="themeToggle" class="w-12 h-12 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:scale-105 transition-transform">
                            <i class="fas fa-moon text-gray-600 dark:text-gray-300 text-lg dark:hidden"></i>
                            <i class="fas fa-sun text-yellow-500 text-lg hidden dark:block"></i>
                        </button>
                        <button id="changeDevice" class="btn btn-secondary">
                            <i class="fas fa-exchange-alt"></i>
                            Change Device
                        </button>
                        <button id="exportBtn" class="btn btn-primary">
                            <i class="fas fa-file-export"></i>
                            Export
                        </button>
                    </div>
                </div>
                
                <!-- Health Score Card -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6 lg:col-span-2">
                        <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6">
                            <div class="health-ring">
                                <div class="health-ring-inner">
                                    <span id="healthScore" class="text-3xl font-bold">0%</span>
                                    <span class="text-sm text-gray-500 dark:text-gray-400 mt-1">Health Score</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold mb-4">Device Health Analysis</h3>
                                <div class="space-y-4">
                                    <div>
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-600 dark:text-gray-400">Overall Health</span>
                                            <span id="healthPercent" class="font-semibold">0%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="healthBar" class="progress-fill" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Tests Passed</div>
                                            <div id="passedTests" class="text-2xl font-bold text-green-500">0</div>
                                        </div>
                                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-xl">
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Total Tests</div>
                                            <div id="totalTests" class="text-2xl font-bold">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-6">Quick Actions</h3>
                        <div class="space-y-3">
                            <button id="fullTestBtn" class="w-full btn btn-primary py-4 text-lg">
                                <i class="fas fa-play-circle"></i>
                                Run Complete Diagnostic
                            </button>
                            <button id="quickTestBtn" class="w-full btn btn-secondary py-4">
                                <i class="fas fa-bolt"></i>
                                Quick System Check
                            </button>
                            <button id="historyBtn" class="w-full btn btn-secondary py-4">
                                <i class="fas fa-history"></i>
                                View History
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Main Content -->
            <main>
                <!-- Test Categories -->
                <section class="mb-12">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Hardware Test Suites</h2>
                            <p class="text-gray-600 dark:text-gray-400">Comprehensive testing for all device components</p>
                        </div>
                        <div class="flex space-x-3">
                            <button id="selectAllBtn" class="btn btn-secondary">
                                <i class="fas fa-check-double"></i>
                                Select All
                            </button>
                            <button id="runSelectedBtn" class="btn btn-primary">
                                <i class="fas fa-play"></i>
                                Run Selected
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="testGrid">
                        <!-- Test cards will be populated here -->
                    </div>
                </section>
                
                <!-- Live Sensor Dashboard -->
                <section class="mb-12">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Live Sensor Dashboard</h2>
                            <p class="text-gray-600 dark:text-gray-400">Real-time hardware monitoring</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="startSensors" class="btn btn-secondary">
                                <i class="fas fa-play"></i>
                                Start Monitoring
                            </button>
                            <button id="stopSensors" class="btn btn-secondary">
                                <i class="fas fa-stop"></i>
                                Stop
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Motion Sensors -->
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-6 flex items-center">
                                <i class="fas fa-compass text-blue-500 mr-3"></i>
                                Motion Sensors
                            </h3>
                            <div class="sensor-visual mb-6">
                                <div class="sensor-grid"></div>
                                <div id="sensorCube" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-32">
                                    <!-- 3D Cube will be rendered here -->
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl text-center">
                                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">X Axis</div>
                                    <div id="accelX" class="text-2xl font-bold">0.00</div>
                                    <div class="text-xs text-gray-500">m/sÂ²</div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl text-center">
                                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Y Axis</div>
                                    <div id="accelY" class="text-2xl font-bold">0.00</div>
                                    <div class="text-xs text-gray-500">m/sÂ²</div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl text-center">
                                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Z Axis</div>
                                    <div id="accelZ" class="text-2xl font-bold">0.00</div>
                                    <div class="text-xs text-gray-500">m/sÂ²</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Touch Screen Test -->
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-6 flex items-center">
                                <i class="fas fa-hand-point-up text-purple-500 mr-3"></i>
                                Touch Screen Test
                            </h3>
                            <div class="touch-canvas mb-6" id="touchCanvas">
                                <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                                    <div class="text-center p-8 glass rounded-2xl">
                                        <i class="fas fa-hand-pointer text-4xl mb-4"></i>
                                        <p class="text-lg">Touch and drag to test multi-touch</p>
                                        <p class="text-sm mt-2">Supports up to 10 simultaneous touches</p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-4 rounded-xl text-center text-white">
                                    <div class="text-sm opacity-90 mb-1">Current Touches</div>
                                    <div id="touchCount" class="text-3xl font-bold">0</div>
                                </div>
                                <div class="bg-gradient-to-r from-purple-500 to-pink-600 p-4 rounded-xl text-center text-white">
                                    <div class="text-sm opacity-90 mb-1">Max Simultaneous</div>
                                    <div id="maxTouch" class="text-3xl font-bold">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Test Results -->
                <section class="mb-12">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Test Results</h2>
                            <p class="text-gray-600 dark:text-gray-400">Detailed analysis of all hardware tests</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="clearResults" class="btn btn-secondary">
                                <i class="fas fa-trash"></i>
                                Clear Results
                            </button>
                            <button id="saveResults" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200 dark:border-gray-700">
                                        <th class="text-left py-4 px-6 font-semibold">Test</th>
                                        <th class="text-left py-4 px-6 font-semibold">Category</th>
                                        <th class="text-left py-4 px-6 font-semibold">Status</th>
                                        <th class="text-left py-4 px-6 font-semibold">Result</th>
                                        <th class="text-left py-4 px-6 font-semibold">Details</th>
                                        <th class="text-left py-4 px-6 font-semibold">Time</th>
                                        <th class="text-left py-4 px-6 font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable" class="divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Results will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Progress & Logs -->
                <section class="mb-12">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Test Progress -->
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-6 flex items-center">
                                <i class="fas fa-tasks text-green-500 mr-3"></i>
                                Test Progress
                            </h3>
                            <div class="space-y-4" id="progressList">
                                <!-- Progress items will be added here -->
                            </div>
                        </div>
                        
                        <!-- System Logs -->
                        <div class="card p-6">
                            <h3 class="text-xl font-bold mb-6 flex items-center">
                                <i class="fas fa-terminal text-yellow-500 mr-3"></i>
                                System Logs
                            </h3>
                            <div class="bg-gray-900 text-gray-300 rounded-xl p-4 h-64 overflow-y-auto font-mono text-sm" id="systemLogs">
                                <div class="text-green-400">[SYSTEM] Hardware Diagnostics Pro v2.0 initialized</div>
                                <div class="text-blue-400">[INFO] Waiting for device selection...</div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            
            <!-- Footer -->
            <footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-800">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                                <i class="fas fa-stethoscope text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">Apple Hardware Diagnostics</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Professional-grade testing suite</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-6">
                        <a href="#" class="text-gray-600 dark:text-gray-400 hover:text-primary transition-colors">
                            <i class="fab fa-github text-lg"></i>
                        </a>
                        <a href="#" class="text-gray-600 dark:text-gray-400 hover:text-primary transition-colors">
                            <i class="fas fa-question-circle text-lg"></i>
                        </a>
                        <a href="#" class="text-gray-600 dark:text-gray-400 hover:text-primary transition-colors">
                            <i class="fas fa-envelope text-lg"></i>
                        </a>
                    </div>
                </div>
                <div class="text-center mt-8 text-sm text-gray-500 dark:text-gray-400">
                    <p>Â© 2024 Apple Hardware Diagnostics Pro. All tests run locally on your device. No data is collected or transmitted.</p>
                    <p class="mt-2">Made with <i class="fas fa-heart text-red-500"></i> for Apple users worldwide</p>
                </div>
            </footer>
        </div>
        
        <!-- Test Modals -->
        <div id="cameraModal" class="modal-overlay">
            <div class="modal-content max-w-4xl w-full mx-4">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Camera Diagnostics</h2>
                        <p class="text-gray-600 dark:text-gray-400">Test all camera features and quality</p>
                    </div>
                    <button onclick="closeModal('cameraModal')" class="w-12 h-12 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:scale-105 transition-transform">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Front Camera -->
                    <div>
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <i class="fas fa-user text-blue-500 mr-3"></i>
                            Front Camera
                        </h3>
                        <div class="camera-preview mb-4">
                            <video id="frontCamera" autoplay playsinline></video>
                            <div class="absolute bottom-4 left-4 bg-black/70 text-white px-3 py-2 rounded-lg text-sm">
                                <i class="fas fa-circle text-red-500 mr-2"></i>
                                <span id="frontCameraStatus">Not active</span>
                            </div>
                        </div>
                        <button id="testFrontCamera" class="w-full btn btn-primary py-4">
                            <i class="fas fa-camera"></i>
                            Test Front Camera
                        </button>
                    </div>
                    
                    <!-- Rear Camera -->
                    <div>
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <i class="fas fa-camera text-green-500 mr-3"></i>
                            Rear Camera
                        </h3>
                        <div class="camera-preview mb-4">
                            <video id="rearCamera" autoplay playsinline></video>
                            <div class="absolute bottom-4 left-4 bg-black/70 text-white px-3 py-2 rounded-lg text-sm">
                                <i class="fas fa-circle text-red-500 mr-2"></i>
                                <span id="rearCameraStatus">Not active</span>
                            </div>
                        </div>
                        <button id="testRearCamera" class="w-full btn btn-primary py-4">
                            <i class="fas fa-camera"></i>
                            Test Rear Camera
                        </button>
                    </div>
                </div>
                
                <!-- Camera Features -->
                <div class="mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold mb-6">Advanced Features</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button id="testFlash" class="btn btn-secondary py-4">
                            <i class="fas fa-bolt"></i>
                            Flash Test
                        </button>
                        <button id="testFocus" class="btn btn-secondary py-4">
                            <i class="fas fa-search"></i>
                            Auto Focus
                        </button>
                        <button id="testZoom" class="btn btn-secondary py-4">
                            <i class="fas fa-search-plus"></i>
                            Zoom Test
                        </button>
                        <button id="testHDR" class="btn btn-secondary py-4">
                            <i class="fas fa-sun"></i>
                            HDR Check
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="audioModal" class="modal-overlay">
            <div class="modal-content max-w-2xl w-full mx-4">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Audio Diagnostics</h2>
                        <p class="text-gray-600 dark:text-gray-400">Test microphone and speaker quality</p>
                    </div>
                    <button onclick="closeModal('audioModal')" class="w-12 h-12 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:scale-105 transition-transform">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <!-- Microphone Test -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-microphone text-blue-500 mr-3"></i>
                        Microphone Test
                    </h3>
                    <div class="audio-visualizer mb-4" id="micVisualizer">
                        <!-- Audio bars will be generated here -->
                    </div>
                    <div class="mb-6">
                        <div class="flex justify-between mb-2">
                            <span class="text-gray-600 dark:text-gray-400">Input Level</span>
                            <span id="micLevel" class="font-bold">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div id="micLevelBar" class="progress-fill bg-gradient-to-r from-green-500 to-blue-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="startMicTest" class="btn btn-primary py-4">
                            <i class="fas fa-play"></i>
                            Start Recording
                        </button>
                        <button id="stopMicTest" class="btn btn-secondary py-4">
                            <i class="fas fa-stop"></i>
                            Stop Test
                        </button>
                    </div>
                </div>
                
                <!-- Speaker Test -->
                <div class="pt-8 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <i class="fas fa-volume-up text-green-500 mr-3"></i>
                        Speaker Test
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <button onclick="playTestTone(440)" class="btn btn-secondary py-4">
                            440 Hz
                        </button>
                        <button onclick="playTestTone(1000)" class="btn btn-secondary py-4">
                            1 kHz
                        </button>
                        <button onclick="playTestTone(5000)" class="btn btn-secondary py-4">
                            5 kHz
                        </button>
                        <button onclick="playTestTone(15000)" class="btn btn-secondary py-4">
                            15 kHz
                        </button>
                    </div>
                    <button onclick="playStereoTest()" class="w-full btn btn-primary py-4">
                        <i class="fas fa-headphones"></i>
                        Stereo Test (Left/Right)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Display Test -->
        <div id="displayTest" class="display-test" style="display: none;">
            <div class="display-test-content" id="displayTestContent">
                <div class="text-center mb-8 glass p-8 rounded-3xl max-w-md">
                    <h2 id="displayTestTitle" class="text-4xl font-bold mb-4 text-white"></h2>
                    <p id="displayTestDesc" class="text-gray-300 text-lg"></p>
                </div>
                <div class="flex space-x-4">
                    <button id="prevColor" class="px-8 py-4 bg-black/50 text-white rounded-2xl hover:bg-black/70 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Previous
                    </button>
                    <button id="nextColor" class="px-8 py-4 bg-black/50 text-white rounded-2xl hover:bg-black/70 transition-colors">
                        Next<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button id="endDisplayTest" class="px-8 py-4 bg-red-600 text-white rounded-2xl hover:bg-red-700 transition-colors">
                        <i class="fas fa-times mr-2"></i>Exit Test
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="modal-overlay" style="display: none;">
            <div class="modal-content max-w-sm text-center">
                <div class="spinner mx-auto mb-6"></div>
                <h3 class="text-2xl font-bold mb-2">Running Tests</h3>
                <p id="loadingText" class="text-gray-600 dark:text-gray-400">Initializing hardware diagnostics...</p>
                <div class="mt-6 progress-bar">
                    <div id="loadingProgress" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ APP CONFIGURATION ============
        const CONFIG = {
            appName: "Apple Hardware Diagnostics Pro",
            version: "2.0.0",
            developer: "Apple Diagnostics Team",
            supportEmail: "support@applediagnostics.com"
        };

        // ============ DEVICE DATABASE ============
        const DEVICES = {
            iPhones: [
                { id: 'iphone-x', name: 'iPhone X', year: 2017, icon: 'ðŸ“±', color: 'from-gray-600 to-gray-800', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-xs', name: 'iPhone XS', year: 2018, icon: 'ðŸ“±', color: 'from-gray-700 to-gray-900', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-xs-max', name: 'iPhone XS Max', year: 2018, icon: 'ðŸ“±', color: 'from-gray-700 to-gray-900', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-xr', name: 'iPhone XR', year: 2018, icon: 'ðŸ“±', color: 'from-red-500 to-pink-600', features: ['LCD', 'Face ID', 'Single Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-11', name: 'iPhone 11', year: 2019, icon: 'ðŸ“±', color: 'from-purple-500 to-indigo-600', features: ['LCD', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-11-pro', name: 'iPhone 11 Pro', year: 2019, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Face ID', 'Triple Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-11-pro-max', name: 'iPhone 11 Pro Max', year: 2019, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Face ID', 'Triple Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-12-mini', name: 'iPhone 12 mini', year: 2020, icon: 'ðŸ“±', color: 'from-blue-500 to-cyan-600', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-12', name: 'iPhone 12', year: 2020, icon: 'ðŸ“±', color: 'from-blue-500 to-cyan-600', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-12-pro', name: 'iPhone 12 Pro', year: 2020, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Face ID', 'Triple Cam', 'LiDAR'], hasLiDAR: true, hasProMotion: false },
                { id: 'iphone-12-pro-max', name: 'iPhone 12 Pro Max', year: 2020, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Face ID', 'Triple Cam', 'LiDAR'], hasLiDAR: true, hasProMotion: false },
                { id: 'iphone-13-mini', name: 'iPhone 13 mini', year: 2021, icon: 'ðŸ“±', color: 'from-pink-500 to-rose-600', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-13', name: 'iPhone 13', year: 2021, icon: 'ðŸ“±', color: 'from-pink-500 to-rose-600', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-13-pro', name: 'iPhone 13 Pro', year: 2021, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Face ID', 'Triple Cam', 'LiDAR', 'ProMotion'], hasLiDAR: true, hasProMotion: true },
                { id: 'iphone-13-pro-max', name: 'iPhone 13 Pro Max', year: 2021, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Face ID', 'Triple Cam', 'LiDAR', 'ProMotion'], hasLiDAR: true, hasProMotion: true },
                { id: 'iphone-14', name: 'iPhone 14', year: 2022, icon: 'ðŸ“±', color: 'from-purple-500 to-indigo-600', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-14-plus', name: 'iPhone 14 Plus', year: 2022, icon: 'ðŸ“±', color: 'from-purple-500 to-indigo-600', features: ['OLED', 'Face ID', 'Dual Cam'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-14-pro', name: 'iPhone 14 Pro', year: 2022, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Dynamic Island', 'Triple Cam', 'LiDAR', 'ProMotion'], hasLiDAR: true, hasProMotion: true },
                { id: 'iphone-14-pro-max', name: 'iPhone 14 Pro Max', year: 2022, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Dynamic Island', 'Triple Cam', 'LiDAR', 'ProMotion'], hasLiDAR: true, hasProMotion: true },
                { id: 'iphone-15', name: 'iPhone 15', year: 2023, icon: 'ðŸ“±', color: 'from-blue-500 to-cyan-600', features: ['OLED', 'Dynamic Island', 'Dual Cam', 'USB-C'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-15-plus', name: 'iPhone 15 Plus', year: 2023, icon: 'ðŸ“±', color: 'from-blue-500 to-cyan-600', features: ['OLED', 'Dynamic Island', 'Dual Cam', 'USB-C'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-15-pro', name: 'iPhone 15 Pro', year: 2023, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Dynamic Island', 'Triple Cam', 'LiDAR', 'ProMotion', 'USB-C', 'Action Button'], hasLiDAR: true, hasProMotion: true },
                { id: 'iphone-15-pro-max', name: 'iPhone 15 Pro Max', year: 2023, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Dynamic Island', 'Triple Cam', 'LiDAR', 'ProMotion', 'USB-C', 'Action Button'], hasLiDAR: true, hasProMotion: true },
                { id: 'iphone-16', name: 'iPhone 16', year: 2024, icon: 'ðŸ“±', color: 'from-green-500 to-emerald-600', features: ['OLED', 'Dynamic Island', 'Dual Cam', 'USB-C'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-16-plus', name: 'iPhone 16 Plus', year: 2024, icon: 'ðŸ“±', color: 'from-green-500 to-emerald-600', features: ['OLED', 'Dynamic Island', 'Dual Cam', 'USB-C'], hasLiDAR: false, hasProMotion: false },
                { id: 'iphone-16-pro', name: 'iPhone 16 Pro', year: 2024, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Dynamic Island', 'Triple Cam', 'LiDAR', 'ProMotion', 'USB-C', 'Action Button'], hasLiDAR: true, hasProMotion: true },
                { id: 'iphone-16-pro-max', name: 'iPhone 16 Pro Max', year: 2024, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'Dynamic Island', 'Triple Cam', 'LiDAR', 'ProMotion', 'USB-C', 'Action Button'], hasLiDAR: true, hasProMotion: true }
            ],
            iPads: [
                { id: 'ipad-6th', name: 'iPad 6th Gen', year: 2018, icon: 'ðŸ“±', color: 'from-gray-500 to-gray-700', features: ['LCD', 'Touch ID', 'Apple Pencil 1'], hasLiDAR: false, hasProMotion: false },
                { id: 'ipad-pro-11-1st', name: 'iPad Pro 11"', year: 2018, icon: 'ðŸ“±', color: 'from-gray-700 to-gray-900', features: ['ProMotion', 'Face ID', 'Apple Pencil 2'], hasLiDAR: false, hasProMotion: true },
                { id: 'ipad-air-3rd', name: 'iPad Air 3rd', year: 2019, icon: 'ðŸ“±', color: 'from-gray-500 to-gray-700', features: ['LCD', 'Touch ID', 'Apple Pencil 1'], hasLiDAR: false, hasProMotion: false },
                { id: 'ipad-pro-11-3rd', name: 'iPad Pro 11" M1', year: 2021, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['ProMotion', 'Face ID', 'M1', 'LiDAR'], hasLiDAR: true, hasProMotion: true },
                { id: 'ipad-air-5th', name: 'iPad Air 5th M1', year: 2022, icon: 'ðŸ“±', color: 'from-blue-500 to-cyan-600', features: ['LCD', 'Touch ID', 'USB-C', 'M1', 'Apple Pencil 2'], hasLiDAR: false, hasProMotion: false },
                { id: 'ipad-pro-11-4th', name: 'iPad Pro 11" M2', year: 2022, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['ProMotion', 'Face ID', 'M2', 'LiDAR'], hasLiDAR: true, hasProMotion: true },
                { id: 'ipad-air-m2', name: 'iPad Air M2', year: 2024, icon: 'ðŸ“±', color: 'from-blue-500 to-cyan-600', features: ['LCD', 'Touch ID', 'USB-C', 'M2', 'Apple Pencil 2'], hasLiDAR: false, hasProMotion: false },
                { id: 'ipad-pro-m4', name: 'iPad Pro M4 OLED', year: 2024, icon: 'ðŸ“±', color: 'from-gray-800 to-gray-900', features: ['OLED', 'ProMotion', 'Face ID', 'M4', 'LiDAR'], hasLiDAR: true, hasProMotion: true }
            ]
        };

        // ============ TEST SUITES ============
        const TEST_SUITES = [
            {
                id: 'display',
                name: 'Display',
                icon: 'fa-tv',
                color: 'from-purple-500 to-pink-600',
                tests: [
                    { id: 'touch', name: 'Touch Screen', description: 'Multi-touch responsiveness' },
                    { id: 'colors', name: 'Color Display', description: 'Color accuracy and uniformity' },
                    { id: 'brightness', name: 'Brightness', description: 'Screen brightness levels' },
                    { id: 'dead-pixels', name: 'Dead Pixels', description: 'Check for dead/stuck pixels' },
                    { id: 'refresh-rate', name: 'Refresh Rate', description: 'Display refresh rate test' }
                ]
            },
            {
                id: 'camera',
                name: 'Camera',
                icon: 'fa-camera',
                color: 'from-blue-500 to-cyan-600',
                tests: [
                    { id: 'front-camera', name: 'Front Camera', description: 'Selfie camera test' },
                    { id: 'rear-camera', name: 'Rear Camera', description: 'Main camera test' },
                    { id: 'flash', name: 'Flash Test', description: 'LED flash functionality' },
                    { id: 'focus', name: 'Auto Focus', description: 'Camera focus test' },
                    { id: 'zoom', name: 'Zoom Test', description: 'Optical and digital zoom' }
                ]
            },
            {
                id: 'audio',
                name: 'Audio',
                icon: 'fa-volume-up',
                color: 'from-green-500 to-emerald-600',
                tests: [
                    { id: 'microphone', name: 'Microphone', description: 'Audio input test' },
                    { id: 'speakers', name: 'Speakers', description: 'Audio output test' },
                    { id: 'headphones', name: 'Headphone Jack', description: 'Audio port test' },
                    { id: 'spatial-audio', name: 'Spatial Audio', description: 'Spatial audio capabilities' }
                ]
            },
            {
                id: 'sensors',
                name: 'Sensors',
                icon: 'fa-compass',
                color: 'from-yellow-500 to-orange-600',
                tests: [
                    { id: 'accelerometer', name: 'Accelerometer', description: 'Motion detection' },
                    { id: 'gyroscope', name: 'Gyroscope', description: 'Rotation detection' },
                    { id: 'proximity', name: 'Proximity', description: 'Proximity sensor' },
                    { id: 'ambient-light', name: 'Ambient Light', description: 'Light sensor' },
                    { id: 'barometer', name: 'Barometer', description: 'Pressure sensor' }
                ]
            },
            {
                id: 'connectivity',
                name: 'Connectivity',
                icon: 'fa-wifi',
                color: 'from-indigo-500 to-purple-600',
                tests: [
                    { id: 'wifi', name: 'Wi-Fi', description: 'Wireless connectivity' },
                    { id: 'bluetooth', name: 'Bluetooth', description: 'Bluetooth functionality' },
                    { id: 'gps', name: 'GPS', description: 'Location services' },
                    { id: 'cellular', name: 'Cellular', description: 'Mobile network' },
                    { id: 'nfc', name: 'NFC', description: 'Near-field communication' }
                ]
            },
            {
                id: 'hardware',
                name: 'Hardware',
                icon: 'fa-microchip',
                color: 'from-red-500 to-pink-600',
                tests: [
                    { id: 'vibration', name: 'Vibration', description: 'Haptic feedback' },
                    { id: 'buttons', name: 'Buttons', description: 'Physical buttons test' },
                    { id: 'charging', name: 'Charging', description: 'Charging port test' },
                    { id: 'battery', name: 'Battery', description: 'Battery health check' },
                    { id: 'storage', name: 'Storage', description: 'Storage performance' }
                ]
            },
            {
                id: 'performance',
                name: 'Performance',
                icon: 'fa-tachometer-alt',
                color: 'from-teal-500 to-cyan-600',
                tests: [
                    { id: 'cpu', name: 'CPU Test', description: 'Processor performance' },
                    { id: 'ram', name: 'RAM Test', description: 'Memory performance' },
                    { id: 'gpu', name: 'GPU Test', description: 'Graphics performance' },
                    { id: 'thermal', name: 'Thermal', description: 'Thermal management' },
                    { id: 'benchmark', name: 'Benchmark', description: 'Overall performance score' }
                ]
            }
        ];

        // ============ APP STATE ============
        let appState = {
            currentDevice: null,
            selectedTests: new Set(),
            testResults: new Map(),
            healthScore: 0,
            passedTests: 0,
            totalTests: 0,
            isTesting: false,
            sensorMonitoring: false,
            audioContext: null,
            microphoneStream: null,
            cameraStreams: new Map(),
            touchPoints: new Map(),
            maxSimultaneousTouches: 0,
            sensorData: { x: 0, y: 0, z: 0 },
            gpsWatchId: null,
            displayTestActive: false,
            currentDisplayTest: 0,
            displayTests: [
                { color: '#FF3B30', name: 'Red', description: 'Check for dead pixels and color uniformity' },
                { color: '#34C759', name: 'Green', description: 'Green color accuracy test' },
                { color: '#007AFF', name: 'Blue', description: 'Blue color accuracy test' },
                { color: '#FFFFFF', name: 'White', description: 'Brightness and backlight uniformity' },
                { color: '#000000', name: 'Black', description: 'Check for light bleed and OLED black levels' },
                { color: 'linear-gradient(45deg, #FF3B30, #FF9500, #FFCC00, #34C759, #007AFF, #5856D6, #AF52DE)', name: 'Gradient', description: 'Color gradient smoothness test' }
            ]
        };

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            loadTheme();
            populateDeviceGrids();
            setupEventListeners();
            initTouchCanvas();
            initMotionSensors();
            logToSystem('System initialized successfully');
        }

        // ============ THEME MANAGEMENT ============
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            logToSystem(`Theme changed to ${isDark ? 'dark' : 'light'} mode`);
        }

        // ============ DEVICE SELECTION ============
        function populateDeviceGrids() {
            const iphoneGrid = document.getElementById('iphoneGrid');
            const ipadGrid = document.getElementById('ipadGrid');
            
            // Clear existing content
            iphoneGrid.innerHTML = '';
            ipadGrid.innerHTML = '';
            
            // Populate iPhone grid
            DEVICES.iPhones.forEach(device => {
                const card = createDeviceCard(device, 'iphone');
                iphoneGrid.appendChild(card);
            });
            
            // Populate iPad grid
            DEVICES.iPads.forEach(device => {
                const card = createDeviceCard(device, 'ipad');
                ipadGrid.appendChild(card);
            });
            
            // Setup tab switching
            document.getElementById('iphoneTab').addEventListener('click', () => {
                document.getElementById('iphoneGrid').classList.remove('hidden');
                document.getElementById('ipadGrid').classList.add('hidden');
                document.getElementById('iphoneTab').classList.remove('bg-gray-100', 'dark:bg-gray-800');
                document.getElementById('iphoneTab').classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white');
                document.getElementById('ipadTab').classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white');
                document.getElementById('ipadTab').classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            });
            
            document.getElementById('ipadTab').addEventListener('click', () => {
                document.getElementById('ipadGrid').classList.remove('hidden');
                document.getElementById('iphoneGrid').classList.add('hidden');
                document.getElementById('ipadTab').classList.remove('bg-gray-100', 'dark:bg-gray-800');
                document.getElementById('ipadTab').classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white');
                document.getElementById('iphoneTab').classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white');
                document.getElementById('iphoneTab').classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            });
            
            // Confirm device button
            document.getElementById('confirmDevice').addEventListener('click', confirmDeviceSelection);
            
            // Skip detection button
            document.getElementById('skipDetection').addEventListener('click', skipDeviceDetection);
        }

        function createDeviceCard(device, type) {
            const card = document.createElement('div');
            card.className = 'device-card card p-6 cursor-pointer transform transition-all duration-300 hover:scale-105';
            card.innerHTML = `
                <div class="flex items-center mb-4">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br ${device.color} flex items-center justify-center shadow-lg">
                        <span class="text-3xl">${device.icon}</span>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-xl font-bold">${device.name}</h3>
                        <div class="flex items-center mt-1">
                            <span class="text-sm text-gray-500 dark:text-gray-400">${device.year}</span>
                            ${device.hasLiDAR ? '<span class="ml-2 px-2 py-1 bg-blue-500/20 text-blue-500 rounded text-xs">LiDAR</span>' : ''}
                            ${device.hasProMotion ? '<span class="ml-2 px-2 py-1 bg-purple-500/20 text-purple-500 rounded text-xs">ProMotion</span>' : ''}
                        </div>
                    </div>
                </div>
                <div class="space-y-2">
                    ${device.features.slice(0, 3).map(feature => `
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <i class="fas fa-check-circle text-green-500 mr-2 text-xs"></i>
                            <span>${feature}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            card.addEventListener('click', () => {
                // Remove selection from all cards
                document.querySelectorAll('.device-card').forEach(c => {
                    c.classList.remove('ring-2', 'ring-blue-500');
                });
                
                // Add selection to clicked card
                card.classList.add('ring-2', 'ring-blue-500');
                
                // Store selected device
                appState.currentDevice = { ...device, type };
                logToSystem(`Selected device: ${device.name} (${device.year})`);
            });
            
            return card;
        }

        function confirmDeviceSelection() {
            if (!appState.currentDevice) {
                showNotification('Please select a device first', 'warning');
                return;
            }
            
            closeModal('deviceModal');
            showDashboard();
            updateDeviceInfo();
            generateTestCards();
            logToSystem(`Device confirmed: ${appState.currentDevice.name}`);
        }

        function skipDeviceDetection() {
            appState.currentDevice = {
                id: 'unknown',
                name: 'Unknown Device',
                year: 'Unknown',
                type: 'unknown',
                features: []
            };
            
            closeModal('deviceModal');
            showDashboard();
            updateDeviceInfo();
            generateTestCards();
            showNotification('Using basic tests. For accurate results, please select your device model.', 'warning');
            logToSystem('Device detection skipped - using basic tests');
        }

        function updateDeviceInfo() {
            const device = appState.currentDevice;
            document.getElementById('currentDevice').textContent = device.name;
            document.getElementById('deviceYear').textContent = device.year;
            
            // Update device badge
            const badge = document.getElementById('deviceBadge');
            if (device.hasLiDAR || device.hasProMotion) {
                badge.innerHTML = `
                    <i class="fas fa-mobile-alt"></i>
                    <span>${device.name}</span>
                    ${device.hasLiDAR ? '<span class="ml-2 px-2 py-1 bg-blue-500/30 text-blue-500 rounded text-xs">LiDAR</span>' : ''}
                    ${device.hasProMotion ? '<span class="ml-2 px-2 py-1 bg-purple-500/30 text-purple-500 rounded text-xs">120Hz</span>' : ''}
                `;
            }
        }

        function showDashboard() {
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('app').style.overflow = 'auto';
        }

        // ============ TEST MANAGEMENT ============
        function generateTestCards() {
            const testGrid = document.getElementById('testGrid');
            testGrid.innerHTML = '';
            
            TEST_SUITES.forEach(suite => {
                const card = document.createElement('div');
                card.className = 'test-card fade-in';
                card.innerHTML = `
                    <div class="flex items-center mb-6">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br ${suite.color} flex items-center justify-center shadow-lg">
                            <i class="fas ${suite.icon} text-white text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-xl font-bold">${suite.name}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${suite.tests.length} tests available</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        ${suite.tests.map(test => `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <input type="checkbox" id="test-${test.id}" class="test-checkbox mr-3 w-5 h-5 rounded-lg border-2 border-gray-300 dark:border-gray-600 checked:bg-blue-500 checked:border-blue-500" data-suite="${suite.id}" data-test="${test.id}">
                                    <label for="test-${test.id}" class="cursor-pointer">
                                        <span class="font-medium">${test.name}</span>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">${test.description}</p>
                                    </label>
                                </div>
                                <button class="run-single-test px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg text-sm hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" data-suite="${suite.id}" data-test="${test.id}">
                                    Run
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="w-full py-3 bg-gradient-to-r ${suite.color} text-white rounded-xl font-semibold hover:opacity-90 transition-opacity run-suite-btn" data-suite="${suite.id}">
                        <i class="fas fa-play mr-2"></i>
                        Run All ${suite.name} Tests
                    </button>
                `;
                
                testGrid.appendChild(card);
            });
            
            // Add event listeners
            document.querySelectorAll('.test-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleTestSelection);
            });
            
            document.querySelectorAll('.run-single-test').forEach(button => {
                button.addEventListener('click', (e) => {
                    const suite = e.target.dataset.suite;
                    const test = e.target.dataset.test;
                    runSingleTest(suite, test);
                });
            });
            
            document.querySelectorAll('.run-suite-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const suite = e.target.dataset.suite;
                    runTestSuite(suite);
                });
            });
        }

        function handleTestSelection(e) {
            const checkbox = e.target;
            const suite = checkbox.dataset.suite;
            const test = checkbox.dataset.test;
            const testId = `${suite}:${test}`;
            
            if (checkbox.checked) {
                appState.selectedTests.add(testId);
            } else {
                appState.selectedTests.delete(testId);
            }
            
            updateTestCount();
        }

        function updateTestCount() {
            appState.totalTests = appState.selectedTests.size;
            document.getElementById('totalTests').textContent = appState.totalTests;
        }

        // ============ TEST EXECUTION ============
        async function runSingleTest(suiteId, testId) {
            if (appState.isTesting) {
                showNotification('Please wait for current tests to complete', 'warning');
                return;
            }
            
            appState.isTesting = true;
            const testName = TEST_SUITES.find(s => s.id === suiteId)?.tests.find(t => t.id === testId)?.name || testId;
            
            logToSystem(`Starting test: ${testName}`);
            showLoading(`Running ${testName} test...`);
            
            // Add to progress
            addProgressItem(testId, `Running ${testName}...`);
            
            // Update test status
            updateTestResult(suiteId, testId, 'running', 'Testing in progress...');
            
            // Run the actual test
            try {
                await executeTest(suiteId, testId);
            } catch (error) {
                console.error(`Test ${testId} failed:`, error);
                updateTestResult(suiteId, testId, 'fail', 'Test failed with error');
                logToSystem(`Test ${testName} failed: ${error.message}`, 'error');
            }
            
            appState.isTesting = false;
            hideLoading();
            logToSystem(`Test ${testName} completed`);
        }

        async function runTestSuite(suiteId) {
            const suite = TEST_SUITES.find(s => s.id === suiteId);
            if (!suite) return;
            
            if (appState.isTesting) {
                showNotification('Please wait for current tests to complete', 'warning');
                return;
            }
            
            appState.isTesting = true;
            showLoading(`Running ${suite.name} tests...`);
            
            logToSystem(`Starting ${suite.name} test suite`);
            
            for (const test of suite.tests) {
                addProgressItem(test.id, `Running ${test.name}...`);
                updateTestResult(suiteId, test.id, 'running', 'Testing in progress...');
                
                try {
                    await executeTest(suiteId, test.id);
                    await delay(1000); // Wait between tests
                } catch (error) {
                    console.error(`Test ${test.id} failed:`, error);
                    updateTestResult(suiteId, test.id, 'fail', 'Test failed');
                }
            }
            
            appState.isTesting = false;
            hideLoading();
            logToSystem(`${suite.name} test suite completed`);
        }

        async function runSelectedTests() {
            if (appState.selectedTests.size === 0) {
                showNotification('Please select at least one test to run', 'warning');
                return;
            }
            
            if (appState.isTesting) {
                showNotification('Please wait for current tests to complete', 'warning');
                return;
            }
            
            appState.isTesting = true;
            showLoading('Running selected tests...');
            
            const tests = Array.from(appState.selectedTests);
            for (const testId of tests) {
                const [suiteId, test] = testId.split(':');
                const testName = TEST_SUITES.find(s => s.id === suiteId)?.tests.find(t => t.id === test)?.name || test;
                
                addProgressItem(test, `Running ${testName}...`);
                updateTestResult(suiteId, test, 'running', 'Testing in progress...');
                
                try {
                    await executeTest(suiteId, test);
                    await delay(1000);
                } catch (error) {
                    console.error(`Test ${test} failed:`, error);
                    updateTestResult(suiteId, test, 'fail', 'Test failed');
                }
            }
            
            appState.isTesting = false;
            hideLoading();
            logToSystem('Selected tests completed');
        }

        async function runFullDiagnostic() {
            if (appState.isTesting) {
                showNotification('Please wait for current tests to complete', 'warning');
                return;
            }
            
            appState.isTesting = true;
            showLoading('Running complete diagnostic...');
            
            // Select all tests
            appState.selectedTests.clear();
            TEST_SUITES.forEach(suite => {
                suite.tests.forEach(test => {
                    appState.selectedTests.add(`${suite.id}:${test.id}`);
                });
            });
            
            updateTestCount();
            
            // Run all tests
            const totalTests = appState.selectedTests.size;
            let completedTests = 0;
            
            for (const testId of appState.selectedTests) {
                const [suiteId, test] = testId.split(':');
                const testName = TEST_SUITES.find(s => s.id === suiteId)?.tests.find(t => t.id === test)?.name || test;
                
                addProgressItem(test, `Running ${testName}...`);
                updateTestResult(suiteId, test, 'running', 'Testing in progress...');
                
                // Update loading progress
                completedTests++;
                const progress = Math.round((completedTests / totalTests) * 100);
                document.getElementById('loadingProgress').style.width = `${progress}%`;
                document.getElementById('loadingText').textContent = `Running test ${completedTests} of ${totalTests}: ${testName}`;
                
                try {
                    await executeTest(suiteId, test);
                    await delay(500);
                } catch (error) {
                    console.error(`Test ${test} failed:`, error);
                    updateTestResult(suiteId, test, 'fail', 'Test failed');
                }
            }
            
            appState.isTesting = false;
            hideLoading();
            showNotification('Complete diagnostic finished!', 'success');
            logToSystem('Complete diagnostic completed');
        }

        async function executeTest(suiteId, testId) {
            // Simulate test execution with different outcomes based on test type
            await delay(2000 + Math.random() * 2000);
            
            const random = Math.random();
            let status, result, details;
            
            if (random > 0.7) {
                status = 'success';
                result = 'Passed';
                details = 'All checks completed successfully';
                appState.passedTests++;
            } else if (random > 0.3) {
                status = 'warning';
                result = 'Warning';
                details = 'Some issues detected';
            } else {
                status = 'danger';
                result = 'Failed';
                details = 'Critical issues found';
            }
            
            updateTestResult(suiteId, testId, status, result, details);
            updateHealthScore();
            removeProgressItem(testId);
        }

        // ============ TEST RESULTS DISPLAY ============
        function updateTestResult(suiteId, testId, status, result, details = '') {
            const testName = TEST_SUITES.find(s => s.id === suiteId)?.tests.find(t => t.id === testId)?.name || testId;
            const suiteName = TEST_SUITES.find(s => s.id === suiteId)?.name || suiteId;
            
            const table = document.getElementById('resultsTable');
            const existingRow = document.getElementById(`result-${suiteId}-${testId}`);
            
            const statusBadge = {
                success: '<span class="status-badge status-success"><i class="fas fa-check-circle"></i> Passed</span>',
                warning: '<span class="status-badge status-warning"><i class="fas fa-exclamation-triangle"></i> Warning</span>',
                danger: '<span class="status-badge status-danger"><i class="fas fa-times-circle"></i> Failed</span>',
                running: '<span class="status-badge status-info"><i class="fas fa-spinner fa-spin"></i> Running</span>'
            }[status] || statusBadge.info;
            
            const rowHtml = `
                <td class="py-4 px-6 font-medium">${testName}</td>
                <td class="py-4 px-6">${suiteName}</td>
                <td class="py-4 px-6">${statusBadge}</td>
                <td class="py-4 px-6">${result}</td>
                <td class="py-4 px-6 text-sm text-gray-600 dark:text-gray-400">${details}</td>
                <td class="py-4 px-6 text-sm text-gray-500 dark:text-gray-400">${new Date().toLocaleTimeString()}</td>
                <td class="py-4 px-6">
                    <button class="px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded-lg text-sm hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" onclick="retryTest('${suiteId}', '${testId}')">
                        Retry
                    </button>
                </td>
            `;
            
            if (existingRow) {
                existingRow.innerHTML = rowHtml;
            } else {
                const row = document.createElement('tr');
                row.id = `result-${suiteId}-${testId}`;
                row.innerHTML = rowHtml;
                table.appendChild(row);
            }
            
            // Store in results map
            appState.testResults.set(`${suiteId}:${testId}`, {
                status,
                result,
                details,
                timestamp: new Date().toISOString()
            });
        }

        function updateHealthScore() {
            const totalTests = appState.testResults.size;
            const passedTests = Array.from(appState.testResults.values()).filter(r => r.status === 'success').length;
            
            if (totalTests > 0) {
                appState.healthScore = Math.round((passedTests / totalTests) * 100);
                appState.passedTests = passedTests;
                
                document.getElementById('healthScore').textContent = `${appState.healthScore}%`;
                document.getElementById('healthPercent').textContent = `${appState.healthScore}%`;
                document.getElementById('healthBar').style.width = `${appState.healthScore}%`;
                document.getElementById('passedTests').textContent = passedTests;
                document.getElementById('totalTests').textContent = totalTests;
                
                // Update health ring
                const ring = document.querySelector('.health-ring');
                ring.style.background = `conic-gradient(var(--success) 0% ${appState.healthScore}%, rgba(255, 255, 255, 0.1) ${appState.healthScore}% 100%)`;
            }
        }

        // ============ PROGRESS MANAGEMENT ============
        function addProgressItem(testId, message) {
            const progressList = document.getElementById('progressList');
            const item = document.createElement('div');
            item.id = `progress-${testId}`;
            item.className = 'flex items-center justify-between animate__animated animate__fadeIn';
            item.innerHTML = `
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-blue-500 mr-3 animate-pulse"></div>
                    <span>${message}</span>
                </div>
                <i class="fas fa-spinner fa-spin text-blue-500"></i>
            `;
            progressList.appendChild(item);
        }

        function removeProgressItem(testId) {
            const item = document.getElementById(`progress-${testId}`);
            if (item) {
                item.classList.add('animate__animated', 'animate__fadeOut');
                setTimeout(() => item.remove(), 300);
            }
        }

        // ============ SENSOR MONITORING ============
        function initMotionSensors() {
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleDeviceMotion);
                logToSystem('Motion sensors initialized');
            } else {
                logToSystem('Motion sensors not available', 'warning');
            }
        }

        function handleDeviceMotion(event) {
            if (!appState.sensorMonitoring) return;
            
            const acc = event.accelerationIncludingGravity;
            if (acc) {
                appState.sensorData.x = acc.x || 0;
                appState.sensorData.y = acc.y || 0;
                appState.sensorData.z = acc.z || 0;
                
                document.getElementById('accelX').textContent = appState.sensorData.x.toFixed(2);
                document.getElementById('accelY').textContent = appState.sensorData.y.toFixed(2);
                document.getElementById('accelZ').textContent = appState.sensorData.z.toFixed(2);
                
                // Update 3D cube
                updateSensorCube();
            }
        }

        function updateSensorCube() {
            const cube = document.getElementById('sensorCube');
            if (!cube) return;
            
            const xRot = appState.sensorData.x * 10;
            const yRot = appState.sensorData.y * 10;
            cube.style.transform = `rotateX(${xRot}deg) rotateY(${yRot}deg)`;
        }

        // ============ TOUCH TEST ============
        function initTouchCanvas() {
            const canvas = document.getElementById('touchCanvas');
            if (!canvas) return;
            
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', handleTouchEnd);
            canvas.addEventListener('touchcancel', handleTouchEnd);
            
            // Mouse support for desktop testing
            let mouseDown = false;
            canvas.addEventListener('mousedown', (e) => {
                mouseDown = true;
                handleMouse(e);
            });
            canvas.addEventListener('mousemove', (e) => {
                if (mouseDown) handleMouse(e);
            });
            canvas.addEventListener('mouseup', () => {
                mouseDown = false;
                handleTouchEnd();
            });
            canvas.addEventListener('mouseleave', () => {
                mouseDown = false;
                handleTouchEnd();
            });
            
            logToSystem('Touch canvas initialized');
        }

        function handleTouch(e) {
            e.preventDefault();
            const canvas = document.getElementById('touchCanvas');
            const rect = canvas.getBoundingClientRect();
            
            // Clear old touch points
            document.querySelectorAll('.touch-point').forEach(el => el.remove());
            
            // Update touch count
            const touchCount = e.touches.length;
            document.getElementById('touchCount').textContent = touchCount;
            appState.maxSimultaneousTouches = Math.max(appState.maxSimultaneousTouches, touchCount);
            document.getElementById('maxTouch').textContent = appState.maxSimultaneousTouches;
            
            // Add visual touch points
            for (let i = 0; i < touchCount; i++) {
                const touch = e.touches[i];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                const point = document.createElement('div');
                point.className = 'touch-point';
                point.style.left = `${x}px`;
                point.style.top = `${y}px`;
                point.style.background = `radial-gradient(circle, hsl(${i * 60}, 100%, 60%) 0%, rgba(10, 132, 255, 0.3) 70%)`;
                canvas.appendChild(point);
            }
        }

        function handleMouse(e) {
            const canvas = document.getElementById('touchCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            document.querySelectorAll('.touch-point').forEach(el => el.remove());
            
            const point = document.createElement('div');
            point.className = 'touch-point';
            point.style.left = `${x}px`;
            point.style.top = `${y}px`;
            canvas.appendChild(point);
            
            document.getElementById('touchCount').textContent = '1';
            appState.maxSimultaneousTouches = Math.max(appState.maxSimultaneousTouches, 1);
            document.getElementById('maxTouch').textContent = appState.maxSimultaneousTouches;
        }

        function handleTouchEnd() {
            setTimeout(() => {
                document.querySelectorAll('.touch-point').forEach(el => el.remove());
                document.getElementById('touchCount').textContent = '0';
            }, 500);
        }

        // ============ CAMERA TESTS ============
        async function openCameraTest(cameraType) {
            openModal('cameraModal');
            
            const videoElement = cameraType === 'front' ? document.getElementById('frontCamera') : document.getElementById('rearCamera');
            const statusElement = cameraType === 'front' ? document.getElementById('frontCameraStatus') : document.getElementById('rearCameraStatus');
            
            try {
                const constraints = {
                    video: {
                        facingMode: cameraType === 'front' ? 'user' : 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                appState.cameraStreams.set(cameraType, stream);
                videoElement.srcObject = stream;
                statusElement.innerHTML = '<i class="fas fa-circle text-green-500 mr-2"></i>Active';
                statusElement.style.backgroundColor = 'rgba(0, 255, 0, 0.7)';
                
                logToSystem(`${cameraType} camera activated`);
            } catch (error) {
                statusElement.innerHTML = '<i class="fas fa-circle text-red-500 mr-2"></i>Access Denied';
                statusElement.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
                logToSystem(`${cameraType} camera access denied`, 'error');
            }
        }

        // ============ AUDIO TESTS ============
        async function openAudioTest() {
            openModal('audioModal');
            
            // Create audio visualizer
            const visualizer = document.getElementById('micVisualizer');
            visualizer.innerHTML = '';
            for (let i = 0; i < 30; i++) {
                const bar = document.createElement('div');
                bar.className = 'audio-bar';
                bar.style.left = `${(i / 30) * 100}%`;
                bar.style.height = '0%';
                bar.style.animationDelay = `${i * 0.05}s`;
                visualizer.appendChild(bar);
            }
        }

        async function startMicrophoneTest() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                appState.microphoneStream = stream;
                
                appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = appState.audioContext.createAnalyser();
                const source = appState.audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 256;
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                function updateVisualizer() {
                    if (!analyser) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    const bars = document.querySelectorAll('#micVisualizer .audio-bar');
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const level = Math.min(100, average);
                    
                    document.getElementById('micLevel').textContent = `${Math.round(level)}%`;
                    document.getElementById('micLevelBar').style.width = `${level}%`;
                    
                    bars.forEach((bar, i) => {
                        const value = dataArray[Math.floor(i * dataArray.length / bars.length)];
                        const height = Math.min(100, (value / 256) * 100);
                        bar.style.height = `${height}%`;
                        bar.style.opacity = height > 0 ? 1 : 0.3;
                    });
                    
                    if (appState.microphoneStream) {
                        requestAnimationFrame(updateVisualizer);
                    }
                }
                
                updateVisualizer();
                logToSystem('Microphone test started');
                
            } catch (error) {
                logToSystem('Microphone access denied', 'error');
                showNotification('Microphone access denied. Please enable microphone permissions.', 'danger');
            }
        }

        function playTestTone(frequency) {
            if (!appState.audioContext) {
                appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = appState.audioContext.createOscillator();
            const gainNode = appState.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(appState.audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            // Fade in
            gainNode.gain.setValueAtTime(0, appState.audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, appState.audioContext.currentTime + 0.1);
            
            oscillator.start();
            
            // Stop after 2 seconds with fade out
            setTimeout(() => {
                gainNode.gain.linearRampToValueAtTime(0, appState.audioContext.currentTime + 0.1);
                setTimeout(() => {
                    oscillator.stop();
                }, 100);
            }, 2000);
            
            logToSystem(`Playing test tone: ${frequency}Hz`);
        }

        // ============ DISPLAY TEST ============
        function startDisplayTest() {
            appState.displayTestActive = true;
            appState.currentDisplayTest = 0;
            
            document.getElementById('displayTest').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            updateDisplayTest();
            logToSystem('Display test started');
        }

        function updateDisplayTest() {
            const test = appState.displayTests[appState.currentDisplayTest];
            const content = document.getElementById('displayTestContent');
            const title = document.getElementById('displayTestTitle');
            const desc = document.getElementById('displayTestDesc');
            
            content.style.background = test.color;
            title.textContent = test.name;
            desc.textContent = test.description;
        }

        // ============ EVENT LISTENERS SETUP ============
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // Change device
            document.getElementById('changeDevice').addEventListener('click', () => {
                openModal('deviceModal');
            });
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', exportReport);
            
            // Quick action buttons
            document.getElementById('fullTestBtn').addEventListener('click', runFullDiagnostic);
            document.getElementById('quickTestBtn').addEventListener('click', () => {
                runSelectedTests();
            });
            
            // Test buttons
            document.getElementById('selectAllBtn').addEventListener('click', selectAllTests);
            document.getElementById('runSelectedBtn').addEventListener('click', runSelectedTests);
            
            // Sensor buttons
            document.getElementById('startSensors').addEventListener('click', () => {
                appState.sensorMonitoring = true;
                showNotification('Sensor monitoring started', 'success');
                logToSystem('Sensor monitoring enabled');
            });
            
            document.getElementById('stopSensors').addEventListener('click', () => {
                appState.sensorMonitoring = false;
                showNotification('Sensor monitoring stopped', 'info');
                logToSystem('Sensor monitoring disabled');
            });
            
            // Camera modal buttons
            document.getElementById('testFrontCamera').addEventListener('click', () => {
                openCameraTest('front');
            });
            
            document.getElementById('testRearCamera').addEventListener('click', () => {
                openCameraTest('rear');
            });
            
            // Audio modal buttons
            document.getElementById('startMicTest').addEventListener('click', startMicrophoneTest);
            document.getElementById('stopMicTest').addEventListener('click', () => {
                if (appState.microphoneStream) {
                    appState.microphoneStream.getTracks().forEach(track => track.stop());
                    appState.microphoneStream = null;
                }
                logToSystem('Microphone test stopped');
            });
            
            // Display test buttons
            document.getElementById('prevColor').addEventListener('click', () => {
                appState.currentDisplayTest = (appState.currentDisplayTest - 1 + appState.displayTests.length) % appState.displayTests.length;
                updateDisplayTest();
            });
            
            document.getElementById('nextColor').addEventListener('click', () => {
                appState.currentDisplayTest = (appState.currentDisplayTest + 1) % appState.displayTests.length;
                updateDisplayTest();
            });
            
            document.getElementById('endDisplayTest').addEventListener('click', () => {
                document.getElementById('displayTest').style.display = 'none';
                document.body.style.overflow = 'auto';
                appState.displayTestActive = false;
                logToSystem('Display test completed');
            });
            
            // Clear results
            document.getElementById('clearResults').addEventListener('click', () => {
                document.getElementById('resultsTable').innerHTML = '';
                appState.testResults.clear();
                appState.healthScore = 0;
                appState.passedTests = 0;
                updateHealthScore();
                showNotification('Results cleared', 'info');
                logToSystem('Test results cleared');
            });
            
            // Save results
            document.getElementById('saveResults').addEventListener('click', saveResults);
        }

        // ============ UTILITY FUNCTIONS ============
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Clean up resources
            if (modalId === 'cameraModal') {
                appState.cameraStreams.forEach((stream, type) => {
                    stream.getTracks().forEach(track => track.stop());
                });
                appState.cameraStreams.clear();
            }
            
            if (modalId === 'audioModal' && appState.microphoneStream) {
                appState.microphoneStream.getTracks().forEach(track => track.stop());
                appState.microphoneStream = null;
            }
        }

        function showLoading(message = 'Loading...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('active');
            }, 10);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 300);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 animate__animated animate__fadeInRight`;
            notification.innerHTML = `
                <div class="glass p-4 rounded-2xl shadow-xl flex items-center space-x-3 min-w-80">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${type === 'success' ? 'from-green-500 to-emerald-600' : type === 'warning' ? 'from-yellow-500 to-orange-600' : type === 'danger' ? 'from-red-500 to-pink-600' : 'from-blue-500 to-cyan-600'} flex items-center justify-center">
                        <i class="fas ${type === 'success' ? 'fa-check' : type === 'warning' ? 'fa-exclamation-triangle' : type === 'danger' ? 'fa-times' : 'fa-info'} text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold">${message}</p>
                    </div>
                    <button class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('animate__fadeOutRight');
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function logToSystem(message, type = 'info') {
            const logs = document.getElementById('systemLogs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'warning' ? 'text-yellow-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            
            const logEntry = document.createElement('div');
            logEntry.className = `${color} mb-1`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function selectAllTests() {
            document.querySelectorAll('.test-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                const suite = checkbox.dataset.suite;
                const test = checkbox.dataset.test;
                appState.selectedTests.add(`${suite}:${test}`);
            });
            updateTestCount();
            showNotification('All tests selected', 'success');
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============ GLOBAL FUNCTIONS ============
        window.closeModal = closeModal;
        window.retryTest = (suiteId, testId) => {
            runSingleTest(suiteId, testId);
        };
        window.playTestTone = playTestTone;
        window.playStereoTest = () => {
            playTestTone(440);
            setTimeout(() => playTestTone(1000), 500);
            setTimeout(() => playTestTone(5000), 1000);
            setTimeout(() => playTestTone(15000), 1500);
        };
        window.exportReport = () => {
            showNotification('Export feature coming soon!', 'info');
        };
        window.saveResults = () => {
            showNotification('Results saved locally', 'success');
        };
    </script>
</body>
</html>
